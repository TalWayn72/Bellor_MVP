# ================================================
# Bellor MVP - WebSocket & Database Alert Rules
# ================================================

groups:
  # ============================================
  # WebSocket Alerts
  # ============================================
  - name: websocket_alerts
    interval: 15s
    rules:
      - alert: WebSocketConnectionDrop
        expr: |
          (
            websocket_active_connections
            / (websocket_active_connections offset 5m)
          ) < 0.5
        for: 5m
        labels:
          severity: P2
          priority: high
          component: websocket
        annotations:
          summary: "WebSocket connections dropped >50%"
          description: "Active connections dropped from {{ with query \"websocket_active_connections offset 5m\" }}{{ . | first | value }}{{ end }} to {{ $value }}."

      - alert: WebSocketHighMessageLatency
        expr: histogram_quantile(0.95, sum(rate(websocket_message_duration_seconds_bucket[5m])) by (le)) > 0.15
        for: 5m
        labels:
          severity: P2
          priority: high
          component: websocket
        annotations:
          summary: "WebSocket message latency >150ms"
          description: "95th percentile WebSocket message latency is {{ $value }}s."

      - alert: WebSocketHighErrorRate
        expr: rate(websocket_connection_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: P3
          priority: medium
          component: websocket
        annotations:
          summary: "WebSocket connection errors elevated"
          description: "WebSocket error rate is {{ $value }}/s."

      - alert: WebSocketOverloaded
        expr: websocket_active_connections > 10000
        for: 5m
        labels:
          severity: P3
          priority: medium
          component: websocket
        annotations:
          summary: "WebSocket connections exceed 10,000"
          description: "Active connections: {{ $value }}. Consider scaling."

  # ============================================
  # Database Alerts
  # ============================================
  - name: database_alerts
    interval: 15s
    rules:
      - alert: DatabaseConnectionPoolExhaustion
        expr: pg_stat_database_numbackends / on() pg_settings_max_connections > 0.85
        for: 2m
        labels:
          severity: P2
          priority: high
          component: database
        annotations:
          summary: "Database connection pool near exhaustion"
          description: "PostgreSQL connections at {{ $value | humanizePercentage }} of max."

      - alert: DatabaseSlowQueries
        expr: rate(pg_stat_statements_mean_exec_time_seconds[5m]) > 0.2
        for: 5m
        labels:
          severity: P3
          priority: medium
          component: database
        annotations:
          summary: "Average query time exceeds 200ms"
          description: "Mean query execution time is {{ $value }}s."

      - alert: DatabaseDeadlocks
        expr: rate(pg_stat_database_deadlocks[5m]) > 0
        for: 5m
        labels:
          severity: P2
          priority: high
          component: database
        annotations:
          summary: "Database deadlocks detected"
          description: "Deadlock rate is {{ $value }}/s on database {{ $labels.datname }}."

      - alert: DatabaseReplicationLag
        expr: pg_replication_lag > 30
        for: 5m
        labels:
          severity: P2
          priority: high
          component: database
        annotations:
          summary: "Database replication lag >30 seconds"
          description: "Replication lag is {{ $value }}s."

      - alert: DatabaseLongRunningQueries
        expr: pg_stat_activity_max_tx_duration > 300
        for: 5m
        labels:
          severity: P3
          priority: medium
          component: database
        annotations:
          summary: "Long-running queries detected (>5 min)"
          description: "Longest running transaction is {{ $value }}s."

      - alert: DatabaseTableBloat
        expr: pg_stat_user_tables_n_dead_tup > 100000
        for: 1h
        labels:
          severity: P4
          priority: low
          component: database
        annotations:
          summary: "Table has >100k dead tuples"
          description: "Table {{ $labels.relname }} has {{ $value }} dead tuples. Consider VACUUM."
