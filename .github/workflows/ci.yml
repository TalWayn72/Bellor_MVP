name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

env:
  NODE_VERSION: '20'

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check TypeScript
        run: npm run type-check

  test-api:
    name: Test API
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: apps/api

      - name: Run database migrations
        run: npx prisma migrate deploy
        working-directory: apps/api
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: Run API tests
        run: npm run test:api -- --coverage
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test_jwt_secret_min_32_chars_long_12345
          JWT_REFRESH_SECRET: test_refresh_secret_min_32_chars_long
          NODE_ENV: test

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./apps/api/coverage/lcov.info
          flags: api
          name: api-coverage
          fail_ci_if_error: false
          verbose: true

  test-web:
    name: Test Web (${{ matrix.shard }}/20)
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Web tests (shard ${{ matrix.shard }}/20)
        run: npx vitest run --shard=${{ matrix.shard }}/20
        working-directory: apps/web
        env:
          NODE_OPTIONS: '--max-old-space-size=6144 --expose-gc'

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: [test-api]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run prisma:generate
        working-directory: apps/api

      - name: Build API
        run: npm run build:api

      - name: Upload API build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: apps/api/dist
          retention-days: 7

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: [test-web]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Web
        run: npm run build:web
        env:
          VITE_API_URL: https://api.bellor.app/api/v1
          VITE_WS_URL: wss://api.bellor.app
          VITE_CDN_URL: https://cdn.bellor.app

      - name: Upload Web build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/dist
          retention-days: 7

      - name: Analyze bundle size
        run: |
          echo "## Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          du -sh apps/web/dist >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Assets:" >> $GITHUB_STEP_SUMMARY
          find apps/web/dist/assets -name "*.js" -exec du -sh {} \; >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build-api, build-web]
    timeout-minutes: 45
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: bellor
          POSTGRES_PASSWORD: bellor_test
          POSTGRES_DB: bellor_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/dist
      - name: Setup database
        run: |
          cd apps/api
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: postgresql://bellor:bellor_test@localhost:5432/bellor_test
      - name: Serve frontend
        run: npx serve -s apps/web/dist -l 5173 &
      - name: Wait for frontend
        run: npx wait-on http://localhost:5173 --timeout 30000
      - name: Run E2E tests
        run: npm run test:e2e -- --project=chromium
        env:
          DATABASE_URL: postgresql://bellor:bellor_test@localhost:5432/bellor_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 7

  visual-regression-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    needs: [build-api, build-web]
    timeout-minutes: 20
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: bellor
          POSTGRES_PASSWORD: bellor_test
          POSTGRES_DB: bellor_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/dist
      - name: Setup database
        run: |
          cd apps/api
          npx prisma migrate deploy
          npx prisma db seed
        env:
          DATABASE_URL: postgresql://bellor:bellor_test@localhost:5432/bellor_test
      - name: Serve frontend
        run: npx serve -s apps/web/dist -l 5173 &
      - name: Wait for frontend
        run: npx wait-on http://localhost:5173 --timeout 30000
      - name: Run visual regression tests
        run: npm run test:visual -- --project=chromium
        env:
          DATABASE_URL: postgresql://bellor:bellor_test@localhost:5432/bellor_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
      - name: Upload visual diff artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-regression-diffs
          path: |
            apps/web/e2e/visual/snapshots/**/*-diff.png
            apps/web/e2e/visual/snapshots/**/*-actual.png
            apps/web/playwright-report/
          retention-days: 14
      - name: Comment on PR with visual diffs
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let comment = '## âš ï¸ Visual Regression Test Failures\n\n';
            comment += 'Visual differences detected. Please review the diff images in the artifacts.\n\n';
            comment += '**Action Items:**\n';
            comment += '- If changes are intentional: Run `npm run test:visual:update` locally and commit the updated snapshots\n';
            comment += '- If changes are unintentional: Fix the UI issue causing the regression\n\n';
            comment += 'ðŸ“¸ [Download visual diff artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [build-api, build-web]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API image (test)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infrastructure/docker/Dockerfile.api
          push: false
          tags: bellor/api:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Web image (test)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infrastructure/docker/Dockerfile.web
          push: false
          tags: bellor/web:test
          build-args: |
            VITE_API_URL=http://localhost:3000/api/v1
            VITE_WS_URL=ws://localhost:3000
            VITE_CDN_URL=http://localhost:3000
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image size report
        run: |
          echo "## Docker Images" >> $GITHUB_STEP_SUMMARY
          docker images bellor/* --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" >> $GITHUB_STEP_SUMMARY

  owasp-zap-scan:
    name: OWASP ZAP Security Scan
    runs-on: ubuntu-latest
    needs: [build-api]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup database
        run: |
          npm run prisma:generate --workspace=@bellor/api
          cd apps/api && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: Start API server for scanning
        run: |
          npm run build:api
          npm run start:api &
          sleep 15
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test_jwt_secret_min_32_chars_long_12345
          JWT_REFRESH_SECRET: test_refresh_secret_min_32_chars_long
          NODE_ENV: production
          PORT: 3000

      - name: Verify API is running
        run: |
          for i in {1..10}; do
            if curl -s http://localhost:3000/health | grep -q "ok"; then
              echo "API is healthy"
              break
            fi
            echo "Waiting for API..."
            sleep 2
          done

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000/'
          rules_file_name: '.zap/rules.tsv'
          fail_action: false
          allow_issue_writing: false
        continue-on-error: true

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

      - name: ZAP Report Summary
        if: always()
        run: |
          echo "## OWASP ZAP Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f report_md.md ]; then
            head -100 report_md.md >> $GITHUB_STEP_SUMMARY
          else
            echo "ZAP scan completed. Check artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
          fi

  load-test-smoke:
    name: Load Test (Smoke)
    runs-on: ubuntu-latest
    needs: [build-api]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Setup API for load test
        run: |
          npm run prisma:generate --workspace=@bellor/api
          cd apps/api && npx prisma migrate deploy
          npm run build:api
          npm run start:api &
          sleep 10
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test_jwt_secret_min_32_chars_long_12345
          JWT_REFRESH_SECRET: test_refresh_secret_min_32_chars_long
          NODE_ENV: production
          PORT: 3000

      - name: Run smoke load test
        run: npm run load:smoke
        continue-on-error: true

      - name: Upload smoke test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results
          path: load-test-results.json
          retention-days: 7

  load-test-sustained:
    name: Load Test (Sustained)
    runs-on: ubuntu-latest
    needs: [build-api]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Setup API for load test
        run: |
          npm run prisma:generate --workspace=@bellor/api
          cd apps/api && npx prisma migrate deploy
          npm run build:api
          npm run start:api &
          sleep 15
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test_jwt_secret_min_32_chars_long_12345
          JWT_REFRESH_SECRET: test_refresh_secret_min_32_chars_long
          NODE_ENV: production
          PORT: 3000

      - name: Run sustained load test
        run: npm run load:sustained
        continue-on-error: true

      - name: Upload sustained test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sustained-load-results
          path: sustained-load-results.json
          retention-days: 30

      - name: Performance Report
        if: always()
        run: |
          echo "## Sustained Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f sustained-load-results.json ]; then
            echo "Test completed. Duration: ~30 minutes" >> $GITHUB_STEP_SUMMARY
            echo "Peak load: 200 concurrent users" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See artifacts for detailed metrics." >> $GITHUB_STEP_SUMMARY
          else
            echo "Test results not available" >> $GITHUB_STEP_SUMMARY
          fi

  load-test-stress:
    name: Load Test (Stress)
    runs-on: ubuntu-latest
    needs: [build-api]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Setup API for load test
        run: |
          npm run prisma:generate --workspace=@bellor/api
          cd apps/api && npx prisma migrate deploy
          npm run build:api
          npm run start:api &
          sleep 15
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test_jwt_secret_min_32_chars_long_12345
          JWT_REFRESH_SECRET: test_refresh_secret_min_32_chars_long
          NODE_ENV: production
          PORT: 3000

      - name: Run stress test
        run: npm run load:stress
        continue-on-error: true

      - name: Upload stress test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stress-test-results
          path: stress-test-results.json
          retention-days: 30

  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, test-api, test-web, build-api, build-web, security-scan, owasp-zap-scan, e2e-tests, visual-regression-tests]
    if: always()

    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.test-api.result }}" == "failure" ]] || \
             [[ "${{ needs.test-web.result }}" == "failure" ]] || \
             [[ "${{ needs.build-api.result }}" == "failure" ]] || \
             [[ "${{ needs.build-web.result }}" == "failure" ]]; then
            echo "CI failed"
            exit 1
          fi
          echo "CI passed successfully"

      - name: Summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | ${{ needs.test-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web Tests | ${{ needs.test-web.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Build | ${{ needs.build-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Web Build | ${{ needs.build-web.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP ZAP | ${{ needs.owasp-zap-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Visual Regression | ${{ needs.visual-regression-tests.result }} |" >> $GITHUB_STEP_SUMMARY
