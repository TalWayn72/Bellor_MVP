name: CD - Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  build-and-push-docker:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for API
        id: meta-api
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/api
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infrastructure/docker/Dockerfile.api
          push: true
          tags: ${{ steps.meta-api.outputs.tags }}
          labels: ${{ steps.meta-api.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata for Web
        id: meta-web
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/web
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infrastructure/docker/Dockerfile.web
          push: true
          tags: ${{ steps.meta-web.outputs.tags }}
          labels: ${{ steps.meta-web.outputs.labels }}
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL }}
            VITE_WS_URL=${{ secrets.VITE_WS_URL }}
            VITE_CDN_URL=${{ secrets.VITE_CDN_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBECONFIG }}

      - name: Create namespace if not exists
        run: |
          kubectl create namespace bellor --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy secrets
        run: |
          kubectl create secret generic bellor-secrets \
            --from-literal=database-url="${{ secrets.DATABASE_URL }}" \
            --from-literal=redis-url="${{ secrets.REDIS_URL }}" \
            --from-literal=jwt-secret="${{ secrets.JWT_SECRET }}" \
            --from-literal=jwt-refresh-secret="${{ secrets.JWT_REFRESH_SECRET }}" \
            --from-literal=r2-endpoint="${{ secrets.R2_ENDPOINT }}" \
            --from-literal=r2-access-key="${{ secrets.R2_ACCESS_KEY }}" \
            --from-literal=r2-secret-key="${{ secrets.R2_SECRET_KEY }}" \
            --from-literal=r2-bucket="${{ secrets.R2_BUCKET }}" \
            --namespace=bellor \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy ConfigMap
        run: |
          kubectl create configmap bellor-config \
            --from-literal=frontend-url="${{ secrets.FRONTEND_URL }}" \
            --from-literal=api-url="${{ secrets.API_URL }}" \
            --from-literal=cdn-url="${{ secrets.CDN_URL }}" \
            --from-literal=jwt-expires-in="15m" \
            --from-literal=jwt-refresh-expires-in="7d" \
            --namespace=bellor \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Update image tags in manifests
        run: |
          export API_IMAGE="ghcr.io/${{ github.repository }}/api:main-${{ github.sha }}"
          export WEB_IMAGE="ghcr.io/${{ github.repository }}/web:main-${{ github.sha }}"

          sed -i "s|image: bellor/api:latest|image: ${API_IMAGE}|g" infrastructure/kubernetes/api-deployment.yaml
          sed -i "s|image: bellor/web:latest|image: ${WEB_IMAGE}|g" infrastructure/kubernetes/web-deployment.yaml

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f infrastructure/kubernetes/namespace.yaml
          kubectl apply -f infrastructure/kubernetes/api-deployment.yaml
          kubectl apply -f infrastructure/kubernetes/web-deployment.yaml
          kubectl apply -f infrastructure/kubernetes/ingress.yaml

      - name: Wait for API rollout
        run: kubectl rollout status deployment/bellor-api -n bellor --timeout=5m

      - name: Wait for Web rollout
        run: kubectl rollout status deployment/bellor-web -n bellor --timeout=5m

      - name: Run database migrations
        run: |
          kubectl exec -n bellor deployment/bellor-api -- \
            sh -c "cd /app/apps/api && npx prisma migrate deploy"

      - name: Verify deployment
        run: |
          kubectl get pods -n bellor
          kubectl get svc -n bellor
          kubectl get ingress -n bellor

  deploy-docker-compose:
    name: Deploy with Docker Compose
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    if: github.event.inputs.environment == 'staging'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/bellor
            git pull origin develop
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            docker compose -f docker-compose.prod.yml exec -T api sh -c "cd /app/apps/api && npx prisma migrate deploy"
            docker compose -f docker-compose.prod.yml ps

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-kubernetes, deploy-docker-compose]
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "Deployment completed with status: ${{ needs.deploy-kubernetes.result }}"
          # Add Slack/Discord/Email notification here
